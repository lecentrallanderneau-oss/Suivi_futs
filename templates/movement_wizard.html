{% extends "base.html" %}
{% block title %}Saisie mouvement{% endblock %}

{% block content %}
<h1 class="h3 mb-3">Nouveau mouvement</h1>

{# ====== ÉTAPE 1 ====== #}
{% if step == 1 %}
<form method="post" action="{{ url_for('movement_wizard', step=1) }}" class="row g-3">

  {% if prefill_client %}
    <div class="col-12">
      <label class="form-label">Client</label>
      <div class="form-control-plaintext">
        <strong>{{ prefill_client.name }}</strong>
        <a class="ms-2 small" href="{{ url_for('movement_wizard', step=1, clear_client=1) }}">(changer)</a>
      </div>
    </div>
  {% else %}
    <div class="col-md-6">
      <label class="form-label">Client</label>
      <select name="client_id" class="form-select" required>
        <option value="" selected disabled>Choisir…</option>
        {% for c in clients %}
          <option value="{{ c.id }}">{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>
  {% endif %}

  <div class="col-md-3">
    <label class="form-label">Type</label>
    <select name="type" class="form-select" required>
      <option value="" selected disabled>Choisir…</option>
      <option value="OUT">Livraison (OUT)</option>
      <option value="IN">Reprise (IN)</option>
      <option value="FULL">Retour plein (FULL)</option>
      <option value="DEFECT">Défectueux (DEFECT)</option>
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Date</label>
    <input type="date" name="date" class="form-control" value="">
  </div>
  <div class="col-12">
    <button type="submit" class="btn btn-primary">Continuer</button>
  </div>
</form>
{% endif %}

{# ====== ÉTAPE 2 ====== #}
{% if step == 2 %}
<form method="post" action="{{ url_for('movement_wizard', step=2) }}">
  {% if prefill_client %}
  <div class="mb-2 text-muted">Client : <strong>{{ prefill_client.name }}</strong></div>
  {% endif %}
  <div class="table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th style="width:50px;"></th>
          <th>Produit</th>
          <th style="width:120px;">Taille</th>
        </tr>
      </thead>
      <tbody>
      {% for v, p in rows %}
        <tr>
          <td><input class="form-check-input" type="checkbox" name="variant_id" value="{{ v.id }}"></td>
          <td>{{ p.name }}</td>
          <td>{% if v.size_l %}{{ ('%.1f'|format(v.size_l)).rstrip('0').rstrip('.') }} L{% else %}—{% endif %}</td>
        </tr>
      {% else %}
        <tr><td colspan="3" class="text-muted text-center">Aucune variante.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="d-flex gap-2">
    <a href="{{ url_for('movement_wizard', step=1) }}" class="btn btn-outline-secondary">Retour</a>
    <button type="submit" class="btn btn-primary">Continuer</button>
  </div>
</form>
{% endif %}

{# ====== ÉTAPE 4 ====== #}
{% if step == 4 %}
<form method="post" action="{{ url_for('movement_wizard', step=4) }}">
  {% if prefill_client %}
  <div class="mb-2 text-muted">Client : <strong>{{ prefill_client.name }}</strong></div>
  {% endif %}

  {% if selected and selected|length > 0 %}
  <div class="table-responsive mb-3">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Produit</th>
          <th style="width:120px;">Taille</th>
          <th style="width:120px;">Qté</th>
          <th style="width:160px;">Prix unitaire TTC</th>
          <th style="width:160px;">Consigne / unité</th>
        </tr>
      </thead>
      <tbody>
      {% for v, p in selected %}
        {% set is_ecocup = ('ecocup' in (p.name|lower) or 'gobelet' in (p.name|lower)) %}
        <tr>
          <td>
            <input type="hidden" name="variant_id" value="{{ v.id }}">
            {{ p.name }}
          </td>
          <td>{% if v.size_l %}{{ ('%.1f'|format(v.size_l)).rstrip('0').rstrip('.') }} L{% else %}—{% endif %}</td>
          <td><input type="number" name="qty" class="form-control" min="0" step="1" value="0" required></td>
          <td><input type="number" name="unit_price_ttc" class="form-control" min="0" step="0.01"
                     placeholder="{{ ('%.2f'|format(v.price_ttc if v.price_ttc is not none else 0)).replace('.', ',') }}"></td>
          <td><input type="number" name="deposit_per_keg" class="form-control" min="0" step="0.01"
                     placeholder="{{ '1,00' if is_ecocup else '30,00' }}"></td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <div class="alert alert-warning">Aucune variante sélectionnée. <a href="{{ url_for('movement_wizard', step=2) }}">Retour étape 2</a></div>
  {% endif %}

  <div class="row g-3">
    <div class="col-md-2">
      <label class="form-label">Tireuses</label>
      <input type="number" name="eq_tireuse" class="form-control" min="0" step="1" value="0">
    </div>
    <div class="col-md-2">
      <label class="form-label">CO₂</label>
      <input type="number" name="eq_co2" class="form-control" min="0" step="1" value="0">
    </div>
    <div class="col-md-3">
      <label class="form-label">Comptoirs</label>
      <input type="number" name="eq_comptoir" class="form-control" min="0" step="1" value="0">
    </div>
    <div class="col-md-3">
      <label class="form-label">Tonnelles</label>
      <input type="number" name="eq_tonnelle" class="form-control" min="0" step="1" value="0">
    </div>
    <div class="col-12">
      <label class="form-label">Notes</label>
      <textarea name="notes" class="form-control" rows="2" placeholder="Ex: tireuse=1;co2=2"></textarea>
    </div>
  </div>

  <div class="d-flex gap-2 mt-3">
    <a href="{{ url_for('movement_wizard', step=2) }}" class="btn btn-outline-secondary">Retour</a>
    <button type="submit" class="btn btn-primary">Enregistrer</button>
  </div>
</form>
{% endif %}
{% endblock %}
