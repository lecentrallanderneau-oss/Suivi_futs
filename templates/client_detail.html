{% extends "base.html" %}
{% import "_macros.html" as ui %}

{% block title %}{{ client.name }} · Détail client{% endblock %}

{% block content %}
<h1 class="h3 mb-3">{{ client.name }}</h1>

<div class="row g-3 mb-3">
  <div class="col-6 col-md-3">
    {{ ui.stat_card("Fûts en jeu", view.kegs) }}
  </div>
  <div class="col-6 col-md-3">
    {{ ui.stat_card("Bière facturée (cumul)", (view.beer_eur)|default(0)|float|round(2) ~ " €") }}
  </div>
  <div class="col-6 col-md-3">
    {{ ui.stat_card("Consignes en jeu", (view.deposit_eur)|default(0)|float|round(2) ~ " €") }}
  </div>
  <div class="col-6 col-md-3">
    {{ ui.stat_card("Litres livrés (cumul)", (view.liters_out_cum)|default(0)|float|round(2)) }}
  </div>
</div>

<div class="mb-3">
  {{ ui.equipment_badges(view.equipment) }}
</div>

<hr class="my-3">

<div class="card">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="h5 mb-0">Historique</div>
      <a class="btn btn-sm btn-primary" href="{{ url_for('movement_wizard', step=1, client_id=client.id) }}">Nouveau mouvement</a>
    </div>

    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th style="width: 130px;">Date</th>
            <th style="width: 120px;">Type</th>
            <th>Produit</th>
            <th style="width: 110px;">Taille</th>
            <th style="width: 90px;">Qté</th>
            <th style="width: 150px;">Prix unitaire TTC</th>
            <th style="width: 150px;">Consigne / unité</th>
            <th style="width: 140px;"></th>
          </tr>
        </thead>
        <tbody>
        {% for m, v, p in movements %}
          {% set pname = (p.name if p is defined and p else "") %}
          {% set size_l = (v.size_l if v is defined and v else None) %}
          {% set unit_price = (m.unit_price_ttc if m.unit_price_ttc is not none else (v.price_ttc if v and v.price_ttc is not none else 0)) %}
          {% set deposit = (m.deposit_per_keg if m.deposit_per_keg is not none else (1.0 if ('ecocup' in pname|lower or 'gobelet' in pname|lower) else 30.0)) %}
          <tr>
            <td>{{ m.created_at|dt }}</td>
            <td>
              {% if m.type == 'OUT' %}Livraison
              {% elif m.type == 'IN' %}Reprise
              {% elif m.type == 'DEFECT' %}Défectueux
              {% elif m.type == 'FULL' %}Retour plein
              {% else %}{{ m.type }}{% endif %}
            </td>
            <td>{{ pname }}</td>
            <td>{% if size_l %}{{ ('%.1f'|format(size_l)).rstrip('0').rstrip('.') }} L{% else %}—{% endif %}</td>
            <td>{{ (m.qty or 0)|int }}</td>
            <td>{% if unit_price is not none %}{{ ('%.2f'|format(unit_price)).replace('.', ',') }} €{% else %}—{% endif %}</td>
            <td>{% if deposit is not none %}{{ ('%.2f'|format(deposit)).replace('.', ',') }} €{% else %}—{% endif %}</td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-danger"
                 href="{{ url_for('movement_confirm_delete', movement_id=m.id) }}">Supprimer</a>
            </td>
          </tr>
          {% if m.notes %}
          <tr class="table-light">
            <td></td>
            <td colspan="7" class="small text-muted">
              <strong>Notes&nbsp;:</strong> {{ m.notes }}
            </td>
          </tr>
          {% endif %}
        {% else %}
          <tr><td colspan="8" class="text-muted text-center">Aucun mouvement.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
