{% extends "base.html" %}
{% import "_macros.html" as ui %}

{% block content %}
  {# On supporte 'c' ou 'client' #}
  {% set ctx = (c if (c is defined) else (client if (client is defined) else none)) %}

  <section class="page-header">
    <h1>{{ ctx.name if ctx else "Client" }}</h1>
    <p class="muted">ID : {{ ctx.id if (ctx and (ctx.id is defined)) else "—" }}</p>
    <p>
      <a href="{{ url_for('index') }}" class="btn">← Retour à l’accueil</a>
      {% if ctx and ctx.id is defined %}
        <a href="{{ url_for('client_edit', client_id=ctx.id) }}" class="btn btn-secondary">Modifier</a>
      {% endif %}
    </p>
  </section>

  {% if ctx and ctx.id is defined %}
  <section class="card">
    <h2>Actions rapides</h2>
    <div class="actions-row">
      {# Nouvelle LIVRAISON #}
      <form method="post" action="{{ url_for('movement_wizard') }}?step=1" class="inline-form">
        <input type="hidden" name="client_id" value="{{ ctx.id }}">
        {# selon ton step1, le champ peut être 'movement_type' ou 'type' ; on met les deux pour compat #}
        <input type="hidden" name="movement_type" value="delivery">
        <input type="hidden" name="type" value="delivery">
        <button type="submit" class="btn btn-primary">+ Nouvelle livraison</button>
      </form>

      {# Nouvelle REPRISE #}
      <form method="post" action="{{ url_for('movement_wizard') }}?step=1" class="inline-form">
        <input type="hidden" name="client_id" value="{{ ctx.id }}">
        <input type="hidden" name="movement_type" value="return">
        <input type="hidden" name="type" value="return">
        <button type="submit" class="btn">↩ Nouvelle reprise</button>
      </form>
    </div>
    <p class="hint">Ces actions ouvrent l’assistant de mouvement directement à l’étape 1, pré-rempli avec ce client.</p>
  </section>
  {% endif %}

  <section class="grid">
    <div class="card">
      <h2>Contact</h2>
      <ul class="list">
        <li><strong>Nom</strong> : {{ ctx.name if ctx else "—" }}</li>
        <li><strong>Email</strong> : {{ ctx.email if (ctx and (ctx.email is defined)) else "—" }}</li>
        <li><strong>Téléphone</strong> : {{ ctx.phone if (ctx and (ctx.phone is defined)) else "—" }}</li>
        <li><strong>Adresse</strong> : {{ ctx.address if (ctx and (ctx.address is defined)) else "—" }}</li>
      </ul>
    </div>

    <div class="card">
      <h2>Fûts en circulation</h2>
      <p class="kpi">{{ keg_qty_in_play if (keg_qty_in_play is defined) else 0 }}</p>
    </div>
  </section>

  {% if deliveries is defined and deliveries %}
    <section class="card">
      <h2>Dernières livraisons</h2>
      <table class="table">
        <thead>
          <tr><th>Date</th><th>Produit</th><th>Qté</th><th>N° fût</th></tr>
        </thead>
        <tbody>
          {% for d in deliveries %}
            <tr>
              <td>{{ d.date or "—" }}</td>
              <td>{{ d.product or "—" }}</td>
              <td>{{ d.qty or "—" }}</td>
              <td>{{ d.keg_serial or "—" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  {% endif %}

  {% if returns is defined and returns %}
    <section class="card">
      <h2>Retours de fûts</h2>
      <table class="table">
        <thead>
          <tr><th>Date</th><th>N° fût</th><th>État</th></tr>
        </thead>
        <tbody>
          {% for r in returns %}
            <tr>
              <td>{{ r.date or "—" }}</td>
              <td>{{ r.keg_serial or "—" }}</td>
              <td>{{ r.status or "—" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  {% endif %}

  {% if balances is defined %}
    <section class="card">
      <h2>Solde client</h2>
      <ul class="list">
        <li><strong>Fûts sortis</strong> : {{ balances.out or 0 }}</li>
        <li><strong>Fûts rentrés</strong> : {{ balances.in or 0 }}</li>
        <li><strong>Solde courant</strong> : {{ balances.current or 0 }}</li>
      </ul>
    </section>
  {% endif %}

{% endblock %}

{% block extra_css %}
<style>
  .actions-row { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center }
  .inline-form { display:inline }
  .btn { border:1px solid #ccc; padding:.5rem .75rem; border-radius:.5rem; text-decoration:none; cursor:pointer }
  .btn-primary { background:#0a7; color:#fff; border-color:#0a7 }
  .btn-secondary { background:#eee }
  .hint { color:#777; font-size:.9rem; margin-top:.5rem }
  .kpi { font-size:2rem; font-weight:700 }
  .grid { display:grid; gap:1rem; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); }
  .card { background:#fff; border:1px solid #e5e5e5; border-radius:.75rem; padding:1rem }
  .table { width:100%; border-collapse:collapse }
  .table th, .table td { border-top:1px solid #eee; padding:.5rem .4rem; text-align:left }
  .muted { color:#888 }
</style>
{% endblock %}
